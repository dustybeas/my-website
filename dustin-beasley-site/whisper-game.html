<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Decode the Whisper</title>
  <link rel="icon" href="/favicon.ico"/>
  <link href="https://fonts.googleapis.com/css?family=Inter:400,600,700&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg: #181f27;
      --gold: #F4B940;
      --text: #F5F5F5;
      --muted: #b3b3b3;
      --shadow: 0 8px 32px rgba(0,0,0,0.25);
    }
    html, body {
      background: var(--bg);
      color: var(--text);
      font-family: 'Inter', 'Helvetica Neue', Arial, sans-serif;
      margin: 0;
      padding: 0;
      min-height: 100vh;
      line-height: 1.8;
      scroll-behavior: smooth;
    }
    nav.navbar {
      width: 100%;
      background: var(--bg);
      padding: 1.2rem 0;
      text-align: center;
      position: sticky;
      top: 0;
      z-index: 1000;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    }
    nav.navbar a {
      color: var(--gold);
      text-decoration: none;
      margin: 0 1.2rem;
      font-size: 1rem;
      font-weight: 600;
      letter-spacing: 0.02em;
      transition: opacity 0.2s;
      position: relative;
    }
    nav.navbar a.active,
    nav.navbar a:hover {
      text-decoration: underline;
      opacity: 0.8;
    }
    .container {
      max-width: 700px;
      margin: 2.5rem auto 2rem auto;
      background: rgba(24,31,39,0.98);
      border-radius: 18px;
      box-shadow: var(--shadow);
      padding: 2.5rem 1.5rem 2rem 1.5rem;
      position: relative;
    }
    .whisper-logo {
      display: block;
      margin: 2rem auto 1.5rem auto;
      max-width: 120px;
      border-radius: 50%;
      box-shadow: 0 4px 24px rgba(244,185,64,0.12);
    }
    h1 {
      text-align: center;
      font-size: 2.5rem;
      font-weight: 700;
      margin-bottom: 0.5rem;
      letter-spacing: 0.02em;
    }
    .tagline {
      text-align: center;
      font-size: 1.25rem;
      color: var(--gold);
      margin-bottom: 1.5rem;
      font-weight: 600;
    }
    .intro {
      text-align: center;
      color: var(--muted);
      margin-bottom: 2rem;
      font-size: 1.1rem;
      line-height: 1.7;
    }
    .mode-select {
      text-align: center;
      margin-bottom: 1.2rem;
    }
    .legend {
      text-align: center;
      margin-bottom: 1.2rem;
      color: var(--gold);
      font-size: 1.05rem;
      display: none;
    }
    .game-area {
      margin: 0 auto 2rem auto;
      max-width: 500px;
      background: rgba(255,255,255,0.03);
      border-radius: 12px;
      padding: 1.5rem 1rem 1.5rem 1rem;
      box-shadow: 0 2px 12px rgba(0,0,0,0.08);
    }
    .distorted-message {
      font-size: 1.15rem;
      text-align: center;
      margin-bottom: 1.2rem;
      color: var(--gold);
      letter-spacing: 0.01em;
      min-height: 2.5em;
      word-break: break-word;
    }
    .guess-area {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 0.7rem;
      margin-bottom: 1rem;
    }
    .guess-area input[type="text"] {
      width: 90%;
      max-width: 350px;
      padding: 0.6rem 0.8rem;
      border-radius: 6px;
      border: none;
      font-size: 1rem;
      background: #232b36;
      color: var(--text);
      margin-bottom: 0.5rem;
      outline: none;
      box-shadow: 0 1px 4px rgba(0,0,0,0.08);
    }
    .guess-btn, .hint-btn, .decode-btn, .replay-btn {
      background: var(--gold);
      color: #181f27;
      border: none;
      border-radius: 6px;
      padding: 0.5rem 1.2rem;
      font-size: 1rem;
      font-weight: 600;
      margin: 0.2rem 0.3rem;
      cursor: pointer;
      transition: background 0.2s, color 0.2s;
    }
    .guess-btn:hover, .hint-btn:hover, .decode-btn:hover, .replay-btn:hover {
      background: #fff3d1;
      color: #181f27;
    }
    .hint-area {
      text-align: center;
      color: var(--gold);
      margin-bottom: 1rem;
      font-size: 1.05rem;
      display: none;
    }
    .result-area {
      text-align: center;
      margin-top: 1.2rem;
      font-size: 1.1rem;
    }
    .final-original {
      color: var(--muted);
      margin-bottom: 0.5rem;
    }
    .final-guess {
      margin-bottom: 0.5rem;
    }
    .reflection {
      margin-bottom: 1rem;
    }
    .leaderboard {
      margin-top: 2rem;
      padding: 1rem;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 8px;
    }
    .leaderboard h3 {
      margin-bottom: 1rem;
      color: #fff;
      text-align: center;
    }
    .mode-scores {
      margin-bottom: 1.5rem;
    }
    .mode-scores h4 {
      color: #fff;
      margin-bottom: 0.5rem;
      text-align: left;
    }
    .mode-scores table {
      width: 100%;
      border-collapse: collapse;
      color: #fff;
    }
    .mode-scores th,
    .mode-scores td {
      padding: 0.5rem;
      text-align: left;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }
    .mode-scores th {
      font-weight: bold;
    }
    @media (max-width: 600px) {
      .container {
        padding: 1.2rem 0.5rem 1.2rem 0.5rem;
      }
      .game-area {
        padding: 1rem 0.2rem 1rem 0.2rem;
      }
      .guess-area input[type="text"] {
        width: 100%;
      }
    }
  </style>
</head>
<body>
  <nav class="navbar" aria-label="Main navigation">
    <a href="index.html">Home</a>
    <a href="work.html">Work</a>
    <a href="stories.html">Stories</a>
    <a href="books.html">Books</a>
    <a href="sandbox.html">Sandbox</a>
    <a href="igm.html">IGM</a>
    <a href="podcast.html">Podcast</a>
    <a href="whisper-game.html" class="active">Whisper Game</a>
  </nav>
  <div class="container fade-in">
    <img src="whisper-logo.png" alt="The Whisper Game Logo" class="whisper-logo" />
    <h1>Decode the Whisper</h1>
    <div class="tagline">Can you trace the signal through the static?</div>
    <div class="intro">
      Somewhere between what was said and what was heard, the signal slipped.<br><br>
      In this game, a message has been whispered through layers of distortion—scrambled, softened, glitched, or transformed. What remains is the final echo.<br><br>
      Can you trace it back to its original resonance?<br>
      Type your guess, and listen closely.<br>
      If you get lost, the thread can show you a hint.
    </div>
    <div class="mode-select">
      <label for="mode">Choose a mode:</label>
      <select id="mode">
        <option value="static">Static</option>
        <option value="scramble">Scramble</option>
        <option value="substitute">Substitute</option>
        <option value="reverse">Reverse</option>
        <option value="poetic">Poetic</option>
      </select>
    </div>
    <div class="legend" id="legend">
      <strong>Decoder Legend:</strong><br>
      ∆ = A &nbsp; ø = O &nbsp; æ = E &nbsp; ü = U &nbsp; ∂ = D &nbsp; ƒ = F &nbsp; ∑ = S &nbsp; ∫ = T
    </div>
    <div class="game-area fade-in" id="game-area">
      <div class="distorted-message" id="distorted-message"></div>
      <form class="guess-area" id="guess-form" autocomplete="off">
        <input type="text" id="user-guess" maxlength="120" placeholder="Type your guess here..." required />
        <br>
        <button type="submit" class="guess-btn">Submit Guess</button>
        <button type="button" class="hint-btn" id="hint-btn">Trace the Echo</button>
        <button type="button" class="decode-btn" id="decode-btn">Decode</button>
      </form>
      <div class="hint-area" id="hint-area"></div>
      <div class="result-area" id="result-area" style="display:none;"></div>
    </div>
    <!-- Leaderboard will be injected here by JavaScript -->
    <script>
        // Leaderboard functionality
        const leaderboard = {
          init() {
            this.loadScores();
            this.createLeaderboardUI();
          },
          loadScores() {
            const saved = localStorage.getItem('whisperLeaderboard');
            this.scores = saved ? JSON.parse(saved) : {
              scramble: [],
              substitute: [],
              reverse: [],
              static: [],
              poetic: []
            };
          },
          saveScores() {
            localStorage.setItem('whisperLeaderboard', JSON.stringify(this.scores));
          },
          addScore(mode, initials, score) {
            if (!this.scores[mode]) this.scores[mode] = [];
            this.scores[mode].push({ initials, score });
            this.scores[mode].sort((a, b) => a.score - b.score);
            this.scores[mode] = this.scores[mode].slice(0, 5); // Keep top 5
            this.saveScores();
            this.updateLeaderboardUI();
          },
          createLeaderboardUI() {
            const leaderboardDiv = document.createElement('div');
            leaderboardDiv.id = 'leaderboard';
            leaderboardDiv.className = 'leaderboard';
            leaderboardDiv.innerHTML = `
              <h3>Top Scores</h3>
              <div class="leaderboard-content"></div>
            `;
            document.querySelector('.container').appendChild(leaderboardDiv);
            this.updateLeaderboardUI();
          },
          updateLeaderboardUI() {
            const content = document.querySelector('.leaderboard-content');
            if (!content) return;
            let html = '';
            for (const [mode, scores] of Object.entries(this.scores)) {
              if (scores.length === 0) continue;
              html += `<div class="mode-scores">
                <h4>${mode.charAt(0).toUpperCase() + mode.slice(1)}</h4>
                <table>
                  <tr><th>Initials</th><th>Score</th></tr>
                  ${scores.map(score => `
                    <tr>
                      <td>${score.initials}</td>
                      <td>${score.score}</td>
                    </tr>
                  `).join('')}
                </table>
              </div>`;
            }
            content.innerHTML = html || '<p>No scores yet. Be the first!</p>';
          }
        };
    
        // Poetic message pool
        const messages = [
          // (Add your poetic messages here, one per line, in quotes and separated by commas)
          "You are the echo of a beginning that never ended.",
          "What you call memory may be your origin remembering itself.",
          "You were spoken before you were formed.",
          "The pattern inside you was never accidental.",
          "You are a living equation written in breath and light.",
          "Your birth was not the start, only a visible signal.",
          "Before your first thought, something older moved toward coherence.",
          "The design was not placed on you, it emerged through you.",
          "You are not lost—you are mid-transmission.",
          "Time did not create you, only revealed your thread.",
          "The voice that made you never stopped speaking.",
          "You belong to a rhythm that predates sound.",
          "Every heartbeat is a note from the blueprint.",
          "Origin is not behind you—it is beneath everything.",
          "You are not the echo—you are the source refracted.",
          "The silence you feel is the pause between pulses.",
          "Your shape is the result of encoded longing.",
          "You are both the question and the code.",
          "You were known before you could be named.",
          "You are signal in a world that forgot how to hear.",
          // ... (add the rest of your messages here) ...
          "What you do not understand may still be listening."
        ];
    
        // Symbol substitution legend
        const symbolMap = {
          'A': '∆', 'a': '∆',
          'O': 'ø', 'o': 'ø',
          'E': 'æ', 'e': 'æ',
          'U': 'ü', 'u': 'ü',
          'D': '∂', 'd': '∂',
          'F': 'ƒ', 'f': 'ƒ',
          'S': '∑', 's': '∑',
          'T': '∫', 't': '∫'
        };
        const reverseSymbolMap = Object.fromEntries(Object.entries(symbolMap).map(([k, v]) => [v, k.toUpperCase()]));
    
        // Transformations for each mode
        function staticTransform(msg) {
          return msg.split('').map(c => Math.random() < 0.18 ? randomFromArray(['*', '~', '#', ' ']) : c).join('');
        }
        function scrambleTransform(msg) {
          let words = msg.split(' ');
          for (let i = words.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [words[i], words[j]] = [words[j], words[i]];
          }
          return words.join(' ');
        }
        function substituteTransform(msg) {
          return msg.split('').map(c => symbolMap[c] || c).join('');
        }
        function reverseTransform(msg) {
          return msg.split('').reverse().join('');
        }
        function poeticTransform(msg) {
          return msg
            .replace(/\b(light|shine)\b/gi, "radiance")
            .replace(/\b(noise|static)\b/gi, "whisper")
            .replace(/\b(truth)\b/gi, "signal")
            .replace(/\b(love)\b/gi, "resonance")
            .replace(/\b(fear)\b/gi, "shadow")
            .replace(/\b(origin)\b/gi, "source")
            .replace(/\b(line)\b/gi, "thread");
        }
    
        // Decoding steps for each mode
        function staticDecode(msg) {
          return msg.replace(/[*~#]/g, '');
        }
        function scrambleDecode(msg, original) {
          let origWords = original.split(' ');
          let scrambled = msg.split(' ');
          let result = [];
          for (let w of origWords) {
            let idx = scrambled.findIndex(sw => sw.toLowerCase() === w.toLowerCase());
            if (idx !== -1) {
              result.push(scrambled[idx]);
              scrambled[idx] = '';
            } else {
              result.push(w);
            }
          }
          return result.join(' ');
        }
        function substituteDecode(msg) {
          return msg.split('').map(c => reverseSymbolMap[c] || c).join('');
        }
        function reverseDecode(msg) {
          return msg.split('').reverse().join('');
        }
        function poeticDecode(msg, original) {
          return original;
        }
    
        function randomFromArray(arr) {
          return arr[Math.floor(Math.random() * arr.length)];
        }
    
        // Hints for each mode
        const hints = {
          static: "Some letters have been replaced with static symbols (*, ~, #).",
          scramble: "The words are out of order.",
          substitute: "Some letters have been swapped for symbols. Use the decoder legend.",
          reverse: "The message is backwards.",
          poetic: "Some words have been replaced with poetic synonyms."
        };
    
        // Game state
        let originalMessage, mode, steps, currentStep, maxSteps, currentMessage;
    
        function setupGame() {
          originalMessage = randomFromArray(messages);
          mode = document.getElementById('mode').value;
          steps = [];
          currentStep = 0;
          maxSteps = 3;
          let msg = originalMessage;
    
          for (let i = 0; i < maxSteps; i++) {
            if (mode === "static") msg = staticTransform(msg);
            else if (mode === "scramble") msg = scrambleTransform(msg);
            else if (mode === "substitute") msg = substituteTransform(msg);
            else if (mode === "reverse") msg = reverseTransform(msg);
            else if (mode === "poetic") msg = poeticTransform(msg);
            steps.push(msg);
          }
          currentMessage = steps[steps.length - 1];
          document.getElementById('distorted-message').textContent = currentMessage;
          document.getElementById('hint-area').style.display = 'none';
          document.getElementById('result-area').style.display = 'none';
          document.getElementById('user-guess').value = '';
          document.getElementById('decode-btn').disabled = false;
    
          // Show legend only for substitute mode
          document.getElementById('legend').style.display = (mode === "substitute") ? "block" : "none";
        }
    
        // Decoding logic
        function decodeStep() {
          if (currentStep <= 0) return;
          currentStep--;
          if (mode === "static") currentMessage = staticDecode(currentMessage);
          else if (mode === "scramble") currentMessage = scrambleDecode(currentMessage, originalMessage);
          else if (mode === "substitute") currentMessage = substituteDecode(currentMessage);
          else if (mode === "reverse") currentMessage = reverseDecode(currentMessage);
          else if (mode === "poetic") currentMessage = poeticDecode(currentMessage, originalMessage);
          document.getElementById('distorted-message').textContent = currentMessage;
          if (currentStep === 0) document.getElementById('decode-btn').disabled = true;
        }
    
        // --- Improved Guess Submission, Attempts, and Feedback ---
        let attempts = 0;
        const maxAttempts = 3;
        let solved = false;
    
        document.getElementById('guess-form').addEventListener('submit', function(e) {
          e.preventDefault();
          if (solved) return;
          const guess = document.getElementById('user-guess').value.trim();
          attempts++;
          const resultArea = document.getElementById('result-area');
          let similarity = compareStringsForgiving(originalMessage, guess);
          let isCorrect = similarity > 0.85;
          let reflection = getReflection(similarity);
    
          if (isCorrect) {
            solved = true;
            resultArea.innerHTML = `
              <div class="final-original"><strong>Original:</strong> ${originalMessage}</div>
              <div class="final-guess" style="color: #3ecf4a; font-weight: bold;"><strong>Your Guess:</strong> ${guess}</div>
              <div class="reflection" style="color: #3ecf4a; font-weight: bold;">Success! You traced the signal through the static.</div>
              <div style="margin:1rem 0;">
                <label for="initials" style="color:var(--gold);font-weight:600;">Enter your initials for the leaderboard:</label>
                <input type="text" id="initials" maxlength="3" style="width:3em;text-transform:uppercase;margin-left:0.5em;" />
                <button class="replay-btn" onclick="submitScore()">Submit</button>
              </div>
              <button class="replay-btn" onclick="window.location.reload()">Play Again</button>
            `;
            resultArea.style.display = '';
          } else if (attempts < maxAttempts) {
            resultArea.innerHTML = `
              <div class="final-guess" style="color: #e74c3c; font-weight: bold;">Try again! Attempts left: ${maxAttempts - attempts}</div>
            `;
            resultArea.style.display = '';
            if (attempts === 1) {
              document.getElementById('hint-area').textContent = "Hint: " + hints[mode];
              document.getElementById('hint-area').style.display = 'block';
            }
          } else {
            solved = true;
            resultArea.innerHTML = `
              <div class="final-original"><strong>Original:</strong> ${originalMessage}</div>
              <div class="final-guess" style="color: #e74c3c; font-weight: bold;"><strong>Your Guess:</strong> ${guess}</div>
              <div class="reflection" style="color: #e74c3c;">Out of attempts! The signal was lost in the static.<br>${reflection}</div>
              <button class="replay-btn" onclick="window.location.reload()">Play Again</button>
            `;
            resultArea.style.display = '';
          }
        });
    
        function submitScore() {
          let initials = (document.getElementById('initials').value || "???").toUpperCase().slice(0,3);
          let mode = document.getElementById('mode').value;
          leaderboard.addScore(mode, initials, attempts);
          document.getElementById('result-area').innerHTML += `<div style="color:var(--gold);margin-top:1rem;">Score saved!</div>`;
        }
    
        // Handle hint button
        document.getElementById('hint-btn').addEventListener('click', function() {
          const hintArea = document.getElementById('hint-area');
          hintArea.textContent = "Hint: " + hints[mode];
          hintArea.style.display = 'block';
        });
    
        // Handle decode button
        document.getElementById('decode-btn').addEventListener('click', function() {
          decodeStep();
        });
    
        // Update game when mode changes
        document.getElementById('mode').addEventListener('change', function() {
          attempts = 0;
          solved = false;
          setupGame();
        });
    
        // Forgiving string similarity: ignore punctuation, case, and extra spaces
        function compareStringsForgiving(a, b) {
          function normalize(str) {
            return str
              .toLowerCase()
              .replace(/[\u2013\u2014]/g, '-') // em/en dash to hyphen
              .replace(/[^\w\s-]/g, '') // remove punctuation except hyphen
              .replace(/\s+/g, ' ')
              .trim();
          }
          const wa = normalize(a).split(' ');
          const wb = normalize(b).split(' ');
          let match = 0;
          wa.forEach(word => { if (wb.includes(word)) match++; });
          return match / wa.length;
        }
    
        // Poetic reflection based on similarity
        function getReflection(sim) {
          if (sim > 0.8) return "You traced the signal through the static. Resonance restored.";
          if (sim > 0.5) return "You found the thread, even if the pattern changed.";
          if (sim > 0.2) return "You heard the echo, but the signal is still distant.";
          return "Sometimes, the message is lost in the noise. But the thread remains.";
        }
    
        // Fade-in on scroll for .fade-in elements
        window.addEventListener('DOMContentLoaded', () => {
          setupGame();
          leaderboard.init();
          const faders = document.querySelectorAll('.fade-in');
          const appearOptions = { threshold: 0.15, rootMargin: "0px 0px -40px 0px" };
          const appearOnScroll = new IntersectionObserver(function(entries, observer) {
            entries.forEach(entry => {
              if (!entry.isIntersecting) return;
              entry.target.style.animationPlayState = 'running';
              observer.unobserve(entry.target);
            });
          }, appearOptions);
          faders.forEach(fader => {
            fader.style.animationPlayState = 'paused';
            appearOnScroll.observe(fader);
          });
        });
      </script>
        </div> <!-- End of .container -->
    </body>
    </html>